<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="M. T. Spedicato, W. Zupa">

<title>Modelling analysis on Litter data – Litter modelling &amp; risk analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-991b1886d3c685c7aa2b62b80640c7af.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<!-- Load Font Awesome for social icons -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>

#header-links {

  margin: 1rem 0;

  display: flex;

  gap: 0.6rem;

}



#header-links a {

  display: inline-flex;

  align-items: center;

  padding: 0.4em 0.8em;

  border: 1px solid #ccc;

  border-radius: 5px;

  text-decoration: none;

  color: #333;

  background: #fff;

  font-size: 0.95em;

  transition: all 0.2s;

}



#header-links a:hover {

  background: #f5f5f5;

}



#header-links img {

  margin-right: 6px;

}

</style>

<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">

<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>



<link rel="stylesheet" href="styles.css">
</head>

<body class="floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./pics/SeaWiseFinal-01.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Litter modelling &amp; risk analysis</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./litter_modelling.html" aria-current="page"> 
<span class="menu-text">Litter Modelling</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./risk_analysis.html"> 
<span class="menu-text">Risk Analysis</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://seawiseproject.org/"> 
<span class="menu-text">SEAwise Website</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/COISPA/litter"> 
<span class="menu-text">COISPA Github</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">Index</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#description-of-the-analysis" id="toc-description-of-the-analysis" class="nav-link" data-scroll-target="#description-of-the-analysis">Description of the analysis</a>
  <ul>
  <li><a href="#user-defined-data" id="toc-user-defined-data" class="nav-link" data-scroll-target="#user-defined-data">User defined data</a></li>
  <li><a href="#set-grid-file" id="toc-set-grid-file" class="nav-link" data-scroll-target="#set-grid-file">Set grid file</a></li>
  <li><a href="#selection-of-response-variable" id="toc-selection-of-response-variable" class="nav-link" data-scroll-target="#selection-of-response-variable">Selection of response variable</a></li>
  <li><a href="#data-loading" id="toc-data-loading" class="nav-link" data-scroll-target="#data-loading">Data loading</a></li>
  <li><a href="#grid-loading" id="toc-grid-loading" class="nav-link" data-scroll-target="#grid-loading">Grid loading</a>
  <ul class="collapse">
  <li><a href="#grid-expansion" id="toc-grid-expansion" class="nav-link" data-scroll-target="#grid-expansion">Grid expansion</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#model-setup" id="toc-model-setup" class="nav-link" data-scroll-target="#model-setup">Model setup</a>
  <ul>
  <li><a href="#selection-of-the-response-variable" id="toc-selection-of-the-response-variable" class="nav-link" data-scroll-target="#selection-of-the-response-variable">selection of the response variable</a></li>
  </ul></li>
  <li><a href="#analysis-on-model-1" id="toc-analysis-on-model-1" class="nav-link" data-scroll-target="#analysis-on-model-1">Analysis on Model 1</a>
  <ul>
  <li><a href="#model-fitting" id="toc-model-fitting" class="nav-link" data-scroll-target="#model-fitting">Model fitting</a></li>
  <li><a href="#saving-model-diagnostics" id="toc-saving-model-diagnostics" class="nav-link" data-scroll-target="#saving-model-diagnostics">Saving model diagnostics</a></li>
  <li><a href="#model-predictions" id="toc-model-predictions" class="nav-link" data-scroll-target="#model-predictions">Model predictions</a></li>
  <li><a href="#averaging-distribution-maps" id="toc-averaging-distribution-maps" class="nav-link" data-scroll-target="#averaging-distribution-maps">Averaging distribution maps</a></li>
  <li><a href="#uncertainty-estimation" id="toc-uncertainty-estimation" class="nav-link" data-scroll-target="#uncertainty-estimation">Uncertainty estimation</a></li>
  <li><a href="#timeseries-plot" id="toc-timeseries-plot" class="nav-link" data-scroll-target="#timeseries-plot">Timeseries plot</a></li>
  </ul></li>
  <li><a href="#analysis-on-model-2" id="toc-analysis-on-model-2" class="nav-link" data-scroll-target="#analysis-on-model-2">Analysis on Model 2</a></li>
  <li><a href="#analysis-on-model-3" id="toc-analysis-on-model-3" class="nav-link" data-scroll-target="#analysis-on-model-3">Analysis on Model 3</a></li>
  <li><a href="#merging-plots-and-results" id="toc-merging-plots-and-results" class="nav-link" data-scroll-target="#merging-plots-and-results">Merging plots and results</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Modelling analysis on Litter data</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>M. T. Spedicato, W. Zupa </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>Compiled on 27/08/2025, 14:26</code></pre>
</div>
</div>
<!-- Logo in the title -->
<style>
/* Make the title line a flex row with the logo on the left */
.title-with-logo {
  display: flex;
  align-items: center;
  gap: 14px;              /* spacing between logo and text */
  margin-top: 0.5rem;
  margin-bottom: 1rem;
}
.title-with-logo img {
  width: 120px;           /* adjust logo size as needed */
  height: auto;
}
</style>
<script>
// Wrap the H1.title with a container and prepend the logo to its left
document.addEventListener("DOMContentLoaded", function(){
  // find the auto-generated title element
  var h1 = document.querySelector("h1.title");
  if(!h1) return;

  // create wrapper
  var wrap = document.createElement("div");
  wrap.className = "title-with-logo";

  // create logo
  var img = document.createElement("img");
  img.src = "pics/SeaWiseFinal-01.png";   // relative path from Rmd root
  img.alt = "SEAwise logo";

  // insert: wrap replaces h1, then put logo + h1 inside wrap
  h1.parentNode.insertBefore(wrap, h1);
  wrap.appendChild(img);
  wrap.appendChild(h1);
});
</script>
<!-- Links -->
<div id="header-links">
<p><a href="https://seawiseproject.org/" target="_blank"> <img src="pics/SeaWiseFinal-01.png" width="20" height="22" style="margin-right:6px; vertical-align:middle;"> SEAwise Website </a> <a href="https://github.com/COISPA/litter" target="_blank"> <img src="pics/github.svg" width="20" height="22" style="margin-right:6px; vertical-align:middle;"> COISPA Github </a></p>
</div>
<!-- start of the script -->
<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This R Markdown template provides a flexible, parameter‑driven workflow for modelling the spatial and temporal distribution of marine litter recorded during scientific surveys. By editing only the small set of parameters that appears at the beginning of the script, such as the study period, the geographical area covered by the analysis, the litter category to be analysed, the response metric and so on, the same code can be rendered for any new case study without further modifications. The template expects two external csv files. The first file contains the observations: one row for every haul, with the haul date, geographical coordinates in decimal degrees, depth, the number and weight of litter items, and either the swept area or the tow duration so that the raw counts can be converted into density indices. The second file is a prediction grid that covers the study region with regularly spaced points; it stores the c-squares cell id, the centroid’ coordinates of each grid cell, depth and any stratification label relevant to the survey design. The resolution of the example grid is 0.05° x 0.05° (~5 km). These files can be replaced freely by the user. Before the statistical analysis begins the script derives a set of density indices (as items or kilograms per square kilometre and per hour) together with a binary presence–absence flag. For the chosen response variable the code fits three candidate Generalised Additive Models with the mgcv package. All models include a two‑dimensional smooth of longitude and latitude, while the temporal component is represented in three alternative ways: a thin‑plate spline of the continuous time variable, a simple factor that treats the year as a categorical effect, or a linear trend. Continuous density responses are modelled with a Tweedie distribution, whereas presence–absence data are handled with a binomial logit. Penalised REML estimation is adopted throughout, and an inflation factor of 1.4 is applied to the smoothing penalty to prevent against overfitting. Model performance is summarised by the percentage of deviance explained and by the Akaike Information Criterion. Once each model has been fitted the script predicts the response at each point of the grid for every survey year and stores the results as plain text. It also builds annual indices of abundance by resampling from the multivariate normal distribution of the model coefficients, which provide confidence intervals for the trend. Figures of the smooth terms, maps of the most recent three‑year average distribution and time‑series plots with confidence envelopes are saved as high‑resolution images, alongside serialised versions of the fitted models and all diagnostic statistics. Everything is written to the user‑defined results directory so that raw data, models and graphics remain clearly separated. To use the template the user only needs to supply an csv file of litter observation by category and a compatible prediction grid, modify the parameter block accordingly to those resources and render the document. The code mostly relies exclusively on CRAN packages (lubridate, dplyr, mgcv, mgcViz, ggplot2, MASS, sf and rnaturalearth) so the workflow can be reproduced on any standard R installation.</p>
</section>
<section id="description-of-the-analysis" class="level1">
<h1>Description of the analysis</h1>
<section id="user-defined-data" class="level2">
<h2 class="anchored" data-anchor-id="user-defined-data">User defined data</h2>
<p>In this section every variable that personalises a run is declared, so that the rest of the script can remain untouched and fully generic. First, two paths are set—one pointing to the folder where all outputs will be written (<em>resdir</em>), the other to the directory that holds the litter data post-classified in csv file format. Creating the results folder in advance avoids errors if it does not yet exist. Next come the temporal and spatial filters. <em>ys</em> lists the survey years that should be considered during the analysis, while <em>AREA</em> identifies the geographic unit (for instance a GSA or ICES subarea) to be extracted later from both the observation table and the prediction grid. The response metric is chosen with response. Five alternative indices are available: densities per square kilometre (<em>n_km2</em>, <em>kg_km2</em>), per hour (<em>n_h</em>, <em>kg_h</em>), or simple presence–absence (<em>pa</em>). <em>category</em> variable then tells the script which litter category, among those reclassified, will be isolated from the source data for modelling. Three numeric values follow. <em>nBoot</em> fixes how many Monte-Carlo replicates will be drawn when the script estimates confidence intervals for the annual indices; a larger number increases precision but lengthens computing time. <em>seeds</em> sets the random-number seed so that results are reproducible. <em>mean_sept_area</em> provides the mean swept area of a haul for the particular survey consideredin order to be attached to every cell of the prediction grid so that model outputs can be predicted on the same scale as the observations. Finally, <em>ref_month</em> chooses the calendar month that will define the temporal frame for the prediction grid, allowing the user to centre predictions on the season of interest.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># set results directory</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>wd <span class="ot">&lt;-</span> <span class="st">"D:</span><span class="sc">\\</span><span class="st">OneDrive - Coispa Tecnologia &amp; Ricerca S.C.A.R.L</span><span class="sc">\\</span><span class="st">SEAwise</span><span class="sc">\\</span><span class="st">_____ARTICOLO_LITTER</span><span class="sc">\\</span><span class="st">___Analysis_2025___</span><span class="sc">\\</span><span class="st">Litter_SEAwise_quarto"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>resdir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"output"</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressWarnings</span>(<span class="fu">dir.create</span>(resdir))</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co"># set directory with data</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>data_dir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(wd, <span class="st">"input"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># set variables</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>ys <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">2013</span><span class="sc">:</span><span class="dv">2021</span>,<span class="dv">2023</span>,<span class="dv">2024</span>) <span class="co"># set the years of data to be used in the analysis</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>AREA <span class="ot">&lt;-</span> <span class="st">"18"</span> <span class="co"># select the geographic area, subarea, GSA for the analysis</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>response <span class="ot">&lt;-</span> <span class="st">"kg_km2"</span> <span class="co"># "n_km2"  "kg_km2" "n_h" "kg_h" "pa"</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>category <span class="ot">&lt;-</span> <span class="st">"FR"</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>nBoot <span class="ot">&lt;-</span> <span class="dv">1000</span> <span class="co"># number of simulation for bootstrapping</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>seeds <span class="ot">&lt;-</span> <span class="dv">42</span> <span class="co"># number of seeds for random functions</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>mean_sept_area <span class="ot">&lt;-</span> <span class="fl">0.05196</span> <span class="co"># mean swept area value in the survey used to create a grid for model predictions</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>ref_month <span class="ot">&lt;-</span> <span class="dv">7</span>  <span class="co"># reference month for the predictive frid</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="set-grid-file" class="level2">
<h2 class="anchored" data-anchor-id="set-grid-file">Set grid file</h2>
<p>In this chunk the user assigns a file name to grid_file. By changing that single line the analyst can substitute a grid of different resolution, spatial extent or depth range without touching any of the statistical code that follows.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>grid_file <span class="ot">&lt;-</span> <span class="st">"grid_0.05_(0-800m)_GSA_csquare.csv"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="selection-of-response-variable" class="level2">
<h2 class="anchored" data-anchor-id="selection-of-response-variable">Selection of response variable</h2>
<p>The chunk builds an expression describing the response variable selected by the user. The result, saved in <em>index_expr</em>, ensures that every axis title, legend and plot annotation later in the document automatically displays the correct unit without further editing when the analysis is rerun with a different response variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>  datasets <span class="ot">&lt;-</span> category <span class="co"># name of the dataset to be loaded</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  datasets_label <span class="ot">&lt;-</span> cats[cats<span class="sc">$</span>cats <span class="sc">==</span> category,<span class="dv">2</span>]  <span class="co"># Label related to the selected category</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"># select response variable</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  index_expr <span class="ot">&lt;-</span> <span class="cf">switch</span>(response,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"n_km2"</span> <span class="ot">=</span> <span class="fu">expression</span>(n <span class="sc">/</span> km<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"kg_km2"</span> <span class="ot">=</span> <span class="fu">expression</span>(kg <span class="sc">/</span> km<span class="sc">^</span><span class="dv">2</span>),</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"n_h"</span> <span class="ot">=</span> <span class="st">"n/h"</span>,</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"kg_h"</span> <span class="ot">=</span> <span class="st">"kg/h"</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"pa"</span> <span class="ot">=</span> <span class="st">"p"</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-loading" class="level2">
<h2 class="anchored" data-anchor-id="data-loading">Data loading</h2>
<p>This step reads the survey file corresponding to the chosen litter category, converts every column name to lower-case for consistency, and inspects the first few rows to confirm that the import succeeded. Immediately afterwards it builds a time variable suitable for smooth modelling. The calendar date of each haul is reconstructed from the year, month and day fields and then converted to “day of year”; dividing by 365 rescales that count onto the interval 0–1, which is easier for a spline to handle. Adding this fractional component back to the integer year yields <em>ctime</em>, a continuous time stamp that increases smoothly from one haul to the next instead of jumping at the turn of each year.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load litter data (observations)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> <span class="fu">read.table</span>(<span class="fu">file.path</span>(data_dir, <span class="fu">paste0</span>(datasets,<span class="st">"_data.csv"</span>)), <span class="at">sep =</span> <span class="st">";"</span>, <span class="at">header =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(data) <span class="ot">&lt;-</span> <span class="fu">tolower</span>(<span class="fu">colnames</span>(data))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["id"],"name":[1],"type":["chr"],"align":["left"]},{"label":["area"],"name":[2],"type":["int"],"align":["right"]},{"label":["country"],"name":[3],"type":["chr"],"align":["left"]},{"label":["year"],"name":[4],"type":["int"],"align":["right"]},{"label":["month"],"name":[5],"type":["int"],"align":["right"]},{"label":["day"],"name":[6],"type":["int"],"align":["right"]},{"label":["depth"],"name":[7],"type":["dbl"],"align":["right"]},{"label":["x"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["y"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["duration"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["swept"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["category"],"name":[12],"type":["chr"],"align":["left"]},{"label":["n"],"name":[13],"type":["int"],"align":["right"]},{"label":["kg"],"name":[14],"type":["dbl"],"align":["right"]}],"data":[{"1":"18ALB2013_PEC716_13","2":"18","3":"ALB","4":"2013","5":"7","6":"16","7":"87.5","8":"19.25342","9":"41.31467","10":"0.5","11":"0.0508374","12":"FR","13":"0","14":"0","_rn_":"1"},{"1":"18ALB2013_PEC716_4","2":"18","3":"ALB","4":"2013","5":"7","6":"16","7":"79.0","8":"19.26858","9":"41.56500","10":"0.5","11":"0.0457683","12":"FR","13":"0","14":"0","_rn_":"2"},{"1":"18ALB2013_PEC716_6","2":"18","3":"ALB","4":"2013","5":"7","6":"16","7":"93.0","8":"19.26825","9":"41.40067","10":"0.5","11":"0.0508374","12":"FR","13":"0","14":"0","_rn_":"3"},{"1":"18ALB2013_PEC716_8","2":"18","3":"ALB","4":"2013","5":"7","6":"16","7":"58.0","8":"19.35217","9":"41.18158","10":"0.5","11":"0.0481290","12":"FR","13":"0","14":"0","_rn_":"4"},{"1":"18ALB2013_PEC717_1","2":"18","3":"ALB","4":"2013","5":"7","6":"17","7":"28.5","8":"19.39592","9":"41.55758","10":"0.5","11":"0.0435624","12":"FR","13":"0","14":"0","_rn_":"5"},{"1":"18ALB2013_PEC717_14","2":"18","3":"ALB","4":"2013","5":"7","6":"17","7":"113.5","8":"19.10417","9":"41.40483","10":"0.5","11":"0.0514647","12":"FR","13":"0","14":"0","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># creation of ctime (continuous time) field</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>date <span class="ot">&lt;-</span> <span class="fu">paste</span>(data<span class="sc">$</span>year,data<span class="sc">$</span>month,data<span class="sc">$</span>day,<span class="at">sep=</span><span class="st">"-"</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>date <span class="ot">&lt;-</span> <span class="fu">yday</span>(date)<span class="sc">/</span><span class="dv">365</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>yday <span class="ot">&lt;-</span> date</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>data<span class="sc">$</span>ctime <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(data[,<span class="fu">which</span>(<span class="fu">colnames</span>(data) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"year"</span>,<span class="st">"yday"</span>))])</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>NYEARS <span class="ot">&lt;-</span> <span class="fu">length</span>(ys)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="grid-loading" class="level2">
<h2 class="anchored" data-anchor-id="grid-loading">Grid loading</h2>
<p>This block imports the spatial prediction grid that underpins all maps and model projections. The grid file is read from the same data directory as the observations, using the file name defined earlier. Immediately after loading, the script filters the grid to retain only the cells whose area code matches the one specified in <em>AREA</em> field, ensuring that any subsequent predictions are confined to the study region of interest. A quick <em>head(grid)</em> prints the first few rows, allowing the user to verify that the grid looks correct before modelling begins.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Load base grid</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">file.path</span>(data_dir,<span class="st">"grid_0.05_(0-800m)_GSA_csquare.csv"</span>), <span class="at">sep =</span> <span class="st">";"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(grid) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"id"</span>, <span class="st">"c_square"</span>, <span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"AREA"</span>, <span class="st">"depth"</span>, <span class="st">"strata"</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> grid[grid<span class="sc">$</span>AREA <span class="sc">==</span> AREA, ]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["id"],"name":[1],"type":["int"],"align":["right"]},{"label":["c_square"],"name":[2],"type":["chr"],"align":["left"]},{"label":["x"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["y"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["AREA"],"name":[5],"type":["int"],"align":["right"]},{"label":["depth"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["strata"],"name":[7],"type":["chr"],"align":["left"]}],"data":[{"1":"13902","2":"1401:215:392:1","3":"15.225","4":"41.925","5":"18","6":"5.80","7":"0_200","_rn_":"2444"},{"1":"14118","2":"1401:215:392:2","3":"15.275","4":"41.925","5":"18","6":"3.75","7":"0_200","_rn_":"2495"},{"1":"14334","2":"1401:215:393:1","3":"15.325","4":"41.925","5":"18","6":"9.55","7":"0_200","_rn_":"2545"},{"1":"14550","2":"1401:215:393:2","3":"15.375","4":"41.925","5":"18","6":"12.45","7":"0_200","_rn_":"2629"},{"1":"14766","2":"1401:215:394:1","3":"15.425","4":"41.925","5":"18","6":"12.75","7":"0_200","_rn_":"2704"},{"1":"14982","2":"1401:215:394:2","3":"15.475","4":"41.925","5":"18","6":"12.40","7":"0_200","_rn_":"2775"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<section id="grid-expansion" class="level3">
<h3 class="anchored" data-anchor-id="grid-expansion">Grid expansion</h3>
<p>At this stage the script turns the purely spatial grid into a spatio-temporal one by duplicating every cell for each survey year listed in <em>ys</em>. When the loop ends, the expanded grid replaces the original. A synthetic date string (always the first day of the chosen month) is then built for every grid row and transformed into “day of year”; dividing by 365 rescales that value to the unit interval. Adding this fraction to the integer year generates <em>ctime</em>, a continuous time stamp that parallels the one computed for the observations data, so the model can evaluate temporal smooths on the prediction grid as well. Finally, each grid row is informed with the variable <em>swept</em>, filled with the survey’s mean swept-area value. This constant offset allows predicted quantities, which are expressed per unit swept area, to be placed on the same scale as the observation densities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>g <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ys)) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  gtemp <span class="ot">&lt;-</span> grid</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  gtemp<span class="sc">$</span>year <span class="ot">&lt;-</span> ys[i]</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  gtemp<span class="sc">$</span>month <span class="ot">&lt;-</span> ref_month</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (i <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> gtemp</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    g <span class="ot">&lt;-</span> <span class="fu">rbind</span>(g, gtemp)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>grid <span class="ot">&lt;-</span> g</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>date <span class="ot">&lt;-</span> <span class="fu">paste</span>(grid<span class="sc">$</span>year, grid<span class="sc">$</span>month, <span class="st">"01"</span>, <span class="at">sep =</span> <span class="st">"-"</span>)</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>date <span class="ot">&lt;-</span> <span class="fu">yday</span>(date) <span class="sc">/</span> <span class="dv">365</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>yday <span class="ot">&lt;-</span> date</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>ctime <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(grid[, <span class="fu">which</span>(<span class="fu">colnames</span>(grid) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"yday"</span>))])</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>grid<span class="sc">$</span>swept <span class="ot">&lt;-</span> mean_sept_area</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="model-setup" class="level1">
<h1>Model setup</h1>
<p>This chunk prepares everything the script needs in order to fit and compare the three alternative GAMs. It first builds an empty data‐frame called fm with six colum (formula, response, model number, dataset name, deviance explained, and AIC), so that summary statistics can be filled in after each model is fitted. The next two lines pre-populate the table: rows 1–3 are given the current response variable and the codes to label the three model variants. The core of the block constructs the model formulas themselves. Each one shares the same two-dimensional Duchon spline (<em>s(x, y, bs = ‘ds’, m = c(1, 0.5), k = 128)</em>) to describe spatial structure, and each includes <em>offset(log(swept))</em> so that predicted values are scaled appropriately for effort. The only difference is how time enters the model:</p>
<ol type="1">
<li>Continuous smoother: adds <em>s(ctime, k = NYEARS, bs = ‘ds’, m = c(1, 0))</em>, letting a smooth function capture gradual trends over the entire study period.</li>
<li>Categorical year effect: replaces the spline with <em>factor(year)</em>, treating each year as an independent level so that no assumption is made about continuity from one year to the next.</li>
<li>Linear trend: inserts the single term <em>ctime</em>, forcing the temporal effect to be strictly linear.</li>
</ol>
<p>Finally the three formulas are printed to the console so the analyst can verify them before the fitting step begins.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create a data frame to store models' statistics</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>fm <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="at">ncol =</span> <span class="dv">6</span>, <span class="at">nrow =</span> <span class="dv">0</span>))</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(fm) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"formula"</span>, <span class="st">"response"</span>, <span class="st">"mod"</span>, <span class="st">"dataset"</span>, <span class="st">"dev.expl"</span>, <span class="st">"AIC"</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>fm[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>), <span class="dv">2</span>] <span class="ot">&lt;-</span> response</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>fm[<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>), <span class="dv">3</span>] <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Definition of model formulas</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 1. Use of continuous time</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>fm[<span class="dv">1</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(response, <span class="st">" ~ s(x,y,bs = 'ds', m = c(1, 0.5),k=128) + s(ctime, k = "</span>, NYEARS, <span class="st">", bs = 'ds', m = c(1, 0)) + offset(log(swept))"</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="do">## 2. Year effect instead of spline</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>fm[<span class="dv">2</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(response, <span class="st">" ~ s(x,y,bs = 'ds', m = c(1, 0.5),k=128) + factor(year) + offset(log(swept))"</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 3. Linear effect of time</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>fm[<span class="dv">3</span>, <span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="fu">paste0</span>(response, <span class="st">" ~ s(x,y,bs = 'ds', m = c(1, 0.5),k=128) + ctime + offset(log(swept))"</span>)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>fm[<span class="dv">1</span>, <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "kg_km2 ~ s(x,y,bs = 'ds', m = c(1, 0.5),k=128) + s(ctime, k = 11, bs = 'ds', m = c(1, 0)) + offset(log(swept))"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>fm[<span class="dv">2</span>, <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "kg_km2 ~ s(x,y,bs = 'ds', m = c(1, 0.5),k=128) + factor(year) + offset(log(swept))"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>fm[<span class="dv">3</span>, <span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "kg_km2 ~ s(x,y,bs = 'ds', m = c(1, 0.5),k=128) + ctime + offset(log(swept))"</code></pre>
</div>
</div>
<section id="selection-of-the-response-variable" class="level2">
<h2 class="anchored" data-anchor-id="selection-of-the-response-variable">selection of the response variable</h2>
<p>After importing the raw haul table the script computes all five candidate response indices in a single step. Two of them (<em>n_km2</em> and <em>kg_km2</em>) are obtained by dividing the item counts and masses by the swept area of each haul, giving densities per square kilometre. Two more (<em>n_h</em> and <em>kg_h</em>) standardise the same quantities by haul duration, producing densities per hour. A binary presence–absence flag, <em>pa</em>, is also created by assigning a value of one to hauls where at least one item was caught and zero otherwise. This code guarantees that whichever index the user selected in the parameter block (<em>response</em>) will already exist as a column in the dataset used.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>dname <span class="ot">&lt;-</span> datasets</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(data)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>n_km2 <span class="ot">&lt;-</span> d<span class="sc">$</span>n <span class="sc">/</span> d<span class="sc">$</span>swept</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>kg_km2 <span class="ot">&lt;-</span> d<span class="sc">$</span>kg <span class="sc">/</span> d<span class="sc">$</span>swept</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>n_h <span class="ot">&lt;-</span> d<span class="sc">$</span>n <span class="sc">/</span> d<span class="sc">$</span>duration</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>kg_h <span class="ot">&lt;-</span> d<span class="sc">$</span>kg <span class="sc">/</span> d<span class="sc">$</span>duration</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>d<span class="sc">$</span>pa <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>d[d<span class="sc">$</span>n <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"pa"</span>] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>d[d<span class="sc">$</span>n <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"pa"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>fm[, <span class="st">"dataset"</span>] <span class="ot">&lt;-</span> dname</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="analysis-on-model-1" class="level1">
<h1>Analysis on Model 1</h1>
<section id="model-fitting" class="level2">
<h2 class="anchored" data-anchor-id="model-fitting">Model fitting</h2>
<p>This first fitting step takes the formula prepared for Model 1 (the version that uses a continuous temporal spline) and feeds it to <em>mgcv::gam</em>. Before the call, a results table called <em>ts_tab</em> is allocated: one row per survey year and separate columns ready to store the three models’ yearly means, confidence limits and coefficients of variation. The object <em>m</em> is set to 1 so the rest of the script knows which row of the formula matrix to pull from. The conditional block chooses the appropriate likelihood according to the response variable the user selected earlier. Presence–absence (pa) triggers a <em>binomial logit</em> specification; any of the continuous density indices triggers the <em>Tweedie (tw())</em> family. In every case the model is estimated by REML and the smoothing penalty is inflated with gamma = 1.4, helping to prevent over-fitting when data are sparse.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ts_tab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="at">ncol =</span> <span class="dv">13</span>, <span class="at">nrow =</span> <span class="fu">length</span>(ys)))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(ts_tab) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"mean_1"</span>, <span class="st">"lower_1"</span>, <span class="st">"higher_1"</span>, <span class="st">"mean_2"</span>, <span class="st">"lower_2"</span>, <span class="st">"higher_2"</span>, <span class="st">"mean_3"</span>, <span class="st">"lower_3"</span>, <span class="st">"higher_3"</span>, <span class="st">"cv1"</span>,<span class="st">"cv2"</span>,<span class="st">"cv3"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>m<span class="ot">=</span><span class="dv">1</span>  <span class="co"># to select model 1</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># fitting</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (response <span class="sc">==</span> <span class="st">"pa"</span>) {</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">gam</span>(<span class="fu">formula</span>(fm[m, <span class="st">"formula"</span>]), <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>), <span class="at">method =</span> <span class="st">"REML"</span>, <span class="at">data =</span> d, <span class="at">gamma=</span><span class="fl">1.4</span>))</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (response <span class="sc">==</span> <span class="st">"n_km2"</span>) {</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">gam</span>(<span class="fu">formula</span>(fm[m, <span class="st">"formula"</span>]), <span class="fu">tw</span>(), <span class="at">method =</span> <span class="st">"REML"</span>, <span class="at">data =</span> d, <span class="at">gamma=</span><span class="fl">1.4</span>))</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (response <span class="sc">==</span> <span class="st">"kg_km2"</span>) {</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">gam</span>(<span class="fu">formula</span>(fm[m, <span class="st">"formula"</span>]), <span class="at">method =</span> <span class="st">"REML"</span>, <span class="fu">tw</span>(), <span class="at">data =</span> d, <span class="at">gamma=</span><span class="fl">1.4</span>))</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (response <span class="sc">==</span> <span class="st">"n_h"</span>) {</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">gam</span>(<span class="fu">formula</span>(fm[m, <span class="st">"formula"</span>]), <span class="fu">tw</span>(), <span class="at">method =</span> <span class="st">"REML"</span>, <span class="at">data =</span> d, <span class="at">gamma=</span><span class="fl">1.4</span>))</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (response <span class="sc">==</span> <span class="st">"kg_km2"</span>) {</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    mod <span class="ot">&lt;-</span> <span class="fu">suppressWarnings</span>(<span class="fu">gam</span>(<span class="fu">formula</span>(fm[m, <span class="st">"formula"</span>]), <span class="at">method =</span> <span class="st">"REML"</span>, <span class="fu">tw</span>(), <span class="at">data =</span> d, <span class="at">gamma=</span><span class="fl">1.4</span>))</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># save gam model object</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(mod, <span class="fu">file.path</span>(resdir, <span class="fu">paste0</span>(dname, <span class="st">"_"</span>, fm[m, <span class="st">"response"</span>], <span class="st">"_"</span>, fm[m, <span class="st">"mod"</span>], <span class="st">"_MODEL.rds"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="saving-model-diagnostics" class="level2">
<h2 class="anchored" data-anchor-id="saving-model-diagnostics">Saving model diagnostics</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># save model summary</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  sum <span class="ot">&lt;-</span> <span class="fu">summary</span>(mod); sum</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Family: Tweedie(p=1.665) 
Link function: log 

Formula:
kg_km2 ~ s(x, y, bs = "ds", m = c(1, 0.5), k = 128) + s(ctime, 
    k = 11, bs = "ds", m = c(1, 0)) + offset(log(swept))

Parametric coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  2.40393    0.09264   25.95   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
            edf Ref.df     F p-value    
s(x,y)   45.031    127 2.106  &lt;2e-16 ***
s(ctime)  1.884     10 0.436  0.0476 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.0456   Deviance explained =   40%
-REML = 926.21  Scale est. = 7.0323    n = 953</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sink</span>(<span class="fu">file.path</span>(resdir, <span class="fu">paste0</span>(dname, <span class="st">"_"</span>, fm[m, <span class="st">"response"</span>], <span class="st">"_"</span>, fm[m, <span class="st">"mod"</span>], <span class="st">"_summary.txt"</span>)))</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(sum)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"AIC: "</span>, <span class="fu">AIC</span>(mod)))</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sink</span>()</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># store model statistics in fm table</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>  fm[m, <span class="st">"dev.expl"</span>] <span class="ot">&lt;-</span> <span class="fu">round</span>(sum<span class="sc">$</span>dev.expl <span class="sc">*</span> <span class="dv">100</span>, <span class="dv">2</span>)</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  fm[m, <span class="st">"AIC"</span>] <span class="ot">&lt;-</span> <span class="fu">AIC</span>(mod); <span class="fu">AIC</span>(mod)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2524.529</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># visualisation plot of splines</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(mod, <span class="at">all.terms =</span> <span class="cn">TRUE</span>, <span class="at">scheme =</span> <span class="dv">2</span>, <span class="at">shade =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="litter_modelling_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># save plot of splines</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  b <span class="ot">&lt;-</span> <span class="fu">getViz</span>(mod)</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">jpeg</span>(<span class="fu">paste</span>(resdir, <span class="fu">paste0</span>(dname, <span class="st">"_"</span>, fm[m, <span class="dv">2</span>], <span class="st">"_"</span>, fm[m, <span class="st">"mod"</span>], <span class="st">"_splines.jpg"</span>), <span class="at">sep =</span> <span class="st">"/"</span>), <span class="at">width =</span> <span class="dv">3000</span>, <span class="at">height =</span> <span class="dv">1500</span>, <span class="at">res =</span> <span class="dv">300</span>)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>      <span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>      <span class="fu">plot</span>(mod, <span class="at">all.terms =</span> <span class="cn">TRUE</span>, <span class="at">scheme =</span> <span class="dv">2</span>, <span class="at">shade =</span> <span class="cn">TRUE</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dev.off</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>png 
  2 </code></pre>
</div>
</div>
</section>
<section id="model-predictions" class="level2">
<h2 class="anchored" data-anchor-id="model-predictions">Model predictions</h2>
<p>This section captures a complete diagnostic picture of the model immediately after it has been fitted. First, <em>summary(mod)</em> is computed and printed to the console so the user can see the principal statistics interactively. The same summary, together with the numeric value of the model’s Akaike Information Criterion, is redirected to a text file for later reference. The model performances are evaluated on the base of percentage deviance explained and AIC, repectivelly reported into the corresponding row of the fm table in order to make later comparisons quicker. The code produces a pair of diagnostic plots that display the fitted spatial smooth and the temporal effect respectivelly. They are first drawn to the current graphics device for on-screen inspection and then exported at high resolution to a JPEG file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># predictions + maps plot</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  grid<span class="sc">$</span>pred <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  grid<span class="sc">$</span>pred <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> grid, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(grid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["id"],"name":[1],"type":["int"],"align":["right"]},{"label":["c_square"],"name":[2],"type":["chr"],"align":["left"]},{"label":["x"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["y"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["AREA"],"name":[5],"type":["int"],"align":["right"]},{"label":["depth"],"name":[6],"type":["dbl"],"align":["right"]},{"label":["strata"],"name":[7],"type":["chr"],"align":["left"]},{"label":["year"],"name":[8],"type":["dbl"],"align":["right"]},{"label":["month"],"name":[9],"type":["dbl"],"align":["right"]},{"label":["yday"],"name":[10],"type":["dbl"],"align":["right"]},{"label":["ctime"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["swept"],"name":[12],"type":["dbl"],"align":["right"]},{"label":["pred"],"name":[13],"type":["dbl[1d]"],"align":["right"]}],"data":[{"1":"13902","2":"1401:215:392:1","3":"15.225","4":"41.925","5":"18","6":"5.80","7":"0_200","8":"2013","9":"7","10":"0.4986301","11":"2013.499","12":"0.05196","13":"6.911618","_rn_":"2444"},{"1":"14118","2":"1401:215:392:2","3":"15.275","4":"41.925","5":"18","6":"3.75","7":"0_200","8":"2013","9":"7","10":"0.4986301","11":"2013.499","12":"0.05196","13":"6.989274","_rn_":"2495"},{"1":"14334","2":"1401:215:393:1","3":"15.325","4":"41.925","5":"18","6":"9.55","7":"0_200","8":"2013","9":"7","10":"0.4986301","11":"2013.499","12":"0.05196","13":"7.073190","_rn_":"2545"},{"1":"14550","2":"1401:215:393:2","3":"15.375","4":"41.925","5":"18","6":"12.45","7":"0_200","8":"2013","9":"7","10":"0.4986301","11":"2013.499","12":"0.05196","13":"7.163909","_rn_":"2629"},{"1":"14766","2":"1401:215:394:1","3":"15.425","4":"41.925","5":"18","6":"12.75","7":"0_200","8":"2013","9":"7","10":"0.4986301","11":"2013.499","12":"0.05196","13":"7.261969","_rn_":"2704"},{"1":"14982","2":"1401:215:394:2","3":"15.475","4":"41.925","5":"18","6":"12.40","7":"0_200","8":"2013","9":"7","10":"0.4986301","11":"2013.499","12":"0.05196","13":"7.367855","_rn_":"2775"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># write.table(grid, file.path(data_dir, paste0("Litter_", dname, "_", fm[m, 2], "_", fm[m, 3], ".csv")), sep = ";", row.names = FALSE)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">write.table</span>(grid, <span class="fu">file.path</span>(resdir, <span class="fu">paste0</span>(<span class="st">"Litter_"</span>, dname, <span class="st">"_"</span>, fm[m, <span class="dv">2</span>], <span class="st">"_"</span>, fm[m, <span class="dv">3</span>], <span class="st">".csv"</span>)), <span class="at">sep =</span> <span class="st">";"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="averaging-distribution-maps" class="level2">
<h2 class="anchored" data-anchor-id="averaging-distribution-maps">Averaging distribution maps</h2>
<p>This chunk summarises the model’s spatial predictions into a single map that illustrates how litter density is currently distributed. It first identifies the last three survey years and extracts from the expanded grid only the rows that belong to those years. Grouping by grid cell, it averages the predicted values across the three slices, yielding one mean estimate per cell (mean). Coastlines are added with rnaturalearth so that land–sea boundaries are clear. The map itself is drawn with ggplot2: each grid cell is a tile coloured by its mean predicted density on a Viridis scale. Customised font sizes ensure that labels remain legible in the exported figure. Finally, the graphic is printed to the R graphics device for immediate inspection and saved twice—once as a high-resolution JPEG for reports and once as a serialised ggplot object (.rds) in case the user wants to re-open or modify the map later without re-running the entire script.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># map of average model estimations for the latest three years</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  last_ys <span class="ot">&lt;-</span> <span class="fu">sort</span>(ys)[(<span class="fu">length</span>(ys)<span class="sc">-</span><span class="dv">2</span>)<span class="sc">:</span><span class="fu">length</span>(ys)]</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  map <span class="ot">&lt;-</span> grid[grid<span class="sc">$</span>year <span class="sc">%in%</span> last_ys, ]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  map <span class="ot">&lt;-</span> map <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(c_square, x,y) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">mean =</span> <span class="fu">mean</span>(pred, <span class="at">na.rm=</span><span class="cn">TRUE</span>))</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>  xmin <span class="ot">&lt;-</span> <span class="fu">min</span>(map<span class="sc">$</span>x)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  xmax <span class="ot">&lt;-</span> <span class="fu">max</span>(map<span class="sc">$</span>x)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  ymin <span class="ot">&lt;-</span> <span class="fu">min</span>(map<span class="sc">$</span>y)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  ymax <span class="ot">&lt;-</span> <span class="fu">max</span>(map<span class="sc">$</span>y)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  xl <span class="ot">&lt;-</span> <span class="fu">c</span>(xmin <span class="sc">-</span> (xmax <span class="sc">-</span> xmin) <span class="sc">*</span> <span class="fl">0.05</span>, xmax <span class="sc">+</span> (xmax <span class="sc">-</span> xmin) <span class="sc">*</span> <span class="fl">0.05</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  yl <span class="ot">&lt;-</span> <span class="fu">c</span>(ymin <span class="sc">-</span> (ymax <span class="sc">-</span> ymin) <span class="sc">*</span> <span class="fl">0.05</span>, ymax <span class="sc">+</span> (ymax <span class="sc">-</span> ymin) <span class="sc">*</span> <span class="fl">0.05</span>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  x_breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">round</span>(xmin, <span class="dv">0</span>), <span class="fu">round</span>(xmin, <span class="dv">0</span>) <span class="sc">+</span> <span class="fu">round</span>((xmax <span class="sc">-</span> xmin) <span class="sc">/</span> <span class="dv">2</span>, <span class="dv">0</span>), <span class="fu">round</span>(xmin, <span class="dv">0</span>) <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">round</span>((xmax <span class="sc">-</span> xmin) <span class="sc">/</span> <span class="dv">2</span>, <span class="dv">0</span>))</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>  y_breaks <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">round</span>(ymin, <span class="dv">0</span>), <span class="fu">round</span>(ymin, <span class="dv">0</span>) <span class="sc">+</span> <span class="fu">round</span>((ymax <span class="sc">-</span> ymin) <span class="sc">/</span> <span class="dv">2</span>, <span class="dv">0</span>), <span class="fu">round</span>(ymin, <span class="dv">0</span>) <span class="sc">+</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">round</span>((ymax <span class="sc">-</span> ymin) <span class="sc">/</span> <span class="dv">2</span>, <span class="dv">0</span>))</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(sf)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearth)</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rnaturalearthdata)</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  world <span class="ot">&lt;-</span> <span class="fu">ne_countries</span>(<span class="at">scale =</span> <span class="st">"large"</span>, <span class="at">returnclass =</span> <span class="st">"sf"</span>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># world &lt;- map_data("world")</span></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(<span class="at">data =</span> map, <span class="fu">aes_string</span>(<span class="at">x =</span> <span class="st">"x"</span>, <span class="at">y =</span> <span class="st">"y"</span>, <span class="at">fill =</span> <span class="st">"mean"</span>)) <span class="sc">+</span></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_viridis_c</span>(<span class="at">option =</span> <span class="st">"D"</span>, <span class="at">direction =</span> <span class="sc">-</span><span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> x_breaks) <span class="sc">+</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> y_breaks) <span class="sc">+</span></span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_sf</span>(<span class="at">data =</span> world, <span class="at">fill =</span> <span class="st">"lightgrey"</span>, <span class="at">color =</span> <span class="st">"darkgrey"</span>, <span class="at">linewidth =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_sf</span>(<span class="at">xlim =</span> xl, <span class="at">ylim =</span> yl, <span class="at">expand =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"Longitude"</span>) <span class="sc">+</span></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ylab</span>(<span class="st">"Latitude"</span>) <span class="sc">+</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">fill =</span> index_expr) <span class="sc">+</span></span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="fu">paste0</span>(datasets_label)) <span class="sc">+</span></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),     </span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>),                 </span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),                  </span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),                </span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>)                 </span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="litter_modelling_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(resdir, <span class="fu">paste0</span>(datasets,<span class="st">"_"</span>,response,<span class="st">"_"</span>,fm[m,<span class="st">"mod"</span>],<span class="st">"_MAP.jpg"</span>), <span class="at">sep =</span> <span class="st">"/"</span>), <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">width =</span> <span class="dv">9</span>, <span class="at">height =</span> <span class="dv">7</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(p1,<span class="fu">paste</span>(resdir, <span class="fu">paste0</span>(datasets,<span class="st">"_"</span>,response,<span class="st">"_"</span>,fm[m,<span class="st">"mod"</span>],<span class="st">"_MAP.rds"</span>), <span class="at">sep =</span> <span class="st">"/"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="uncertainty-estimation" class="level2">
<h2 class="anchored" data-anchor-id="uncertainty-estimation">Uncertainty estimation</h2>
<p>The analysis at this stage generates haul-level predictions from the fitted GAM, replacing the observed response column with model-based values so that each haul retains its original covariates and sampling design. Afterwards, it moves on to quantify uncertainty. The code produces values for model predictions at haul level, then, year by year, draws a number (<em>nBoot</em>=1000) random coefficient sets from the GAM’s multivariate-normal posterior. Each draw yields a new set of haul densities; averaging these within the year produces a distribution of possible annual means. From that distribution the script stores the point estimate, a 95 % confidence interval, and a coefficient of variation, placing the results in a summary table.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>  <span class="co"># model prediction at the survey stations</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  hauls <span class="ot">&lt;-</span> d</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  hauls[,<span class="fu">which</span>(<span class="fu">colnames</span>(hauls)<span class="sc">==</span>response)] <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simulation from the posterior distribution and calculation of the linear predictor (the right-hand side of GAM equation) for each simulation</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (fm[m, <span class="st">"dev.expl"</span>] <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"- Estimation of time series' 95% confidence interval: </span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="fu">paste</span>(dname, <span class="st">", "</span>, fm[m, <span class="dv">2</span>], <span class="st">", model"</span>, fm[m, <span class="st">"mod"</span>], <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>))</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create data frame of the time series</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>  ts <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">matrix</span>(<span class="at">ncol =</span> <span class="dv">5</span>, <span class="at">nrow =</span> <span class="fu">length</span>(ys)))</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(ts) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"year"</span>, <span class="st">"mean"</span>, <span class="st">"lower"</span>, <span class="st">"higher"</span>, <span class="st">"cv"</span>)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># predictions by year</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  y<span class="ot">=</span><span class="dv">1</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (y <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(ys)) {</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    n.row <span class="ot">&lt;-</span> <span class="fu">nrow</span>(hauls[hauls<span class="sc">$</span>year<span class="sc">==</span>ys[y],])</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    Xp<span class="fl">.1</span> <span class="ot">=</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> hauls[hauls<span class="sc">$</span>year<span class="sc">==</span>ys[y],], <span class="at">type =</span> <span class="st">"lpmatrix"</span>)</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    OS.pos <span class="ot">=</span> <span class="fu">numeric</span>(<span class="fu">nrow</span>(hauls[hauls<span class="sc">$</span>year<span class="sc">==</span>ys[y],]))</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    terms.pos <span class="ot">=</span> <span class="fu">terms</span>(mod)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    Xp<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">predict</span>(mod, <span class="at">newdata =</span> hauls[hauls<span class="sc">$</span>year<span class="sc">==</span>ys[y],], <span class="at">type =</span> <span class="st">"lpmatrix"</span>)</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    brp<span class="fl">.1</span> <span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(<span class="at">n =</span> nBoot, <span class="fu">coef</span>(mod), mod<span class="sc">$</span>Vp)</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    rep1 <span class="ot">&lt;-</span> <span class="fu">exp</span>(Xp<span class="fl">.1</span> <span class="sc">%*%</span> <span class="fu">t</span>(brp<span class="fl">.1</span>))</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    cv <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">apply</span>(rep1, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">sd</span>(x) <span class="sc">/</span> <span class="fu">mean</span>(x)), <span class="dv">2</span>)</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    cv <span class="ot">&lt;-</span> <span class="fu">mean</span>(cv)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(mod<span class="sc">$</span>offset)) {</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>      off.num.pos <span class="ot">&lt;-</span> <span class="fu">attr</span>(terms.pos, <span class="st">"offset"</span>)</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> off.num.pos) OS.pos <span class="ot">&lt;-</span> OS.pos <span class="sc">+</span> <span class="fu">eval</span>(<span class="fu">attr</span>(terms.pos,<span class="st">"variables"</span>)[[i <span class="sc">+</span> <span class="dv">1</span>]], hauls[hauls<span class="sc">$</span>year<span class="sc">==</span>ys[y],])</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    p<span class="fl">.1</span> <span class="ot">=</span> Xp<span class="fl">.1</span> <span class="sc">%*%</span> <span class="fu">coef</span>(mod) <span class="sc">+</span> OS.pos</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>    gPred <span class="ot">=</span> <span class="fu">exp</span>(p<span class="fl">.1</span>)</span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>    pred_year <span class="ot">=</span> <span class="fu">sum</span>(<span class="fu">exp</span>(p<span class="fl">.1</span>))<span class="sc">/</span>n.row</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>    brp<span class="fl">.1</span> <span class="ot">=</span> <span class="fu">mvrnorm</span>(<span class="at">n =</span> nBoot, <span class="fu">coef</span>(mod), mod<span class="sc">$</span>Vp)</span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>    OS.pos <span class="ot">=</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="fu">nrow</span>(hauls[hauls<span class="sc">$</span>year<span class="sc">==</span>ys[y],]), nBoot)</span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>    terms.pos <span class="ot">=</span> <span class="fu">terms</span>(mod)</span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">is.null</span>(mod<span class="sc">$</span>offset)) {</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>      off.num.pos <span class="ot">&lt;-</span> <span class="fu">attr</span>(terms.pos, <span class="st">"offset"</span>)</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> (i <span class="cf">in</span> off.num.pos) OS.pos <span class="ot">&lt;-</span> OS.pos <span class="sc">+</span> <span class="fu">eval</span>(<span class="fu">attr</span>(terms.pos,<span class="st">"variables"</span>)[[i <span class="sc">+</span> <span class="dv">1</span>]], hauls[hauls<span class="sc">$</span>year<span class="sc">==</span>ys[y],])</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a>    rep1 <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="fu">exp</span>(Xp<span class="fl">.1</span> <span class="sc">%*%</span> <span class="fu">t</span>(brp<span class="fl">.1</span>) <span class="sc">+</span> OS.pos))</span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a>    idxSamp <span class="ot">=</span> <span class="fu">as.numeric</span>(<span class="fu">colSums</span>(rep1))<span class="sc">/</span>n.row</span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    halpha <span class="ot">=</span> (<span class="dv">1</span> <span class="sc">-</span> <span class="fl">0.95</span>)<span class="sc">/</span><span class="dv">2</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    hi <span class="ot">&lt;-</span> <span class="fu">quantile</span>(idxSamp, <span class="dv">1</span> <span class="sc">-</span> halpha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a>    lo <span class="ot">&lt;-</span> <span class="fu">quantile</span>(idxSamp, halpha, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    ts[y, <span class="dv">1</span>] <span class="ot">&lt;-</span> ys[y]</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>    ts[y, <span class="dv">2</span>] <span class="ot">&lt;-</span> pred_year </span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>    ts[y, <span class="dv">3</span>] <span class="ot">&lt;-</span> lo</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>    ts[y, <span class="dv">4</span>] <span class="ot">&lt;-</span> hi</span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>    ts[y, <span class="dv">5</span>] <span class="ot">&lt;-</span> cv</span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># table containing  time series for all the 3 models</span></span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (fm[m,<span class="st">"mod"</span>]<span class="sc">==</span><span class="dv">1</span>) {</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>      ts_tab[,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)] <span class="ot">&lt;-</span> ts[,<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)]</span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>      ts_tab[,<span class="dv">11</span>] <span class="ot">&lt;-</span> ts[,<span class="dv">5</span>]</span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (fm[m,<span class="st">"mod"</span>]<span class="sc">==</span><span class="dv">2</span>) {</span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>      ts_tab[,<span class="fu">c</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">7</span>)] <span class="ot">&lt;-</span> ts[,<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>)]</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>      ts_tab[,<span class="dv">12</span>] <span class="ot">&lt;-</span> ts[,<span class="dv">5</span>]</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> <span class="cf">if</span> (fm[m,<span class="st">"mod"</span>]<span class="sc">==</span><span class="dv">3</span>) {</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>      ts_tab[,<span class="fu">c</span>(<span class="dv">8</span><span class="sc">:</span><span class="dv">10</span>)] <span class="ot">&lt;-</span> ts[,<span class="fu">c</span>(<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>)]</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>      ts_tab[,<span class="dv">13</span>] <span class="ot">&lt;-</span> ts[,<span class="dv">5</span>]</span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(ts_tab)</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>  }</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>- Estimation of time series' 95% confidence interval: 
FR ,  kg_km2 , model 1 </code></pre>
</div>
<div class="cell-output-display">
<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["year"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["mean_1"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["lower_1"],"name":[3],"type":["dbl"],"align":["right"]},{"label":["higher_1"],"name":[4],"type":["dbl"],"align":["right"]},{"label":["mean_2"],"name":[5],"type":["lgl"],"align":["right"]},{"label":["lower_2"],"name":[6],"type":["lgl"],"align":["right"]},{"label":["higher_2"],"name":[7],"type":["lgl"],"align":["right"]},{"label":["mean_3"],"name":[8],"type":["lgl"],"align":["right"]},{"label":["lower_3"],"name":[9],"type":["lgl"],"align":["right"]},{"label":["higher_3"],"name":[10],"type":["lgl"],"align":["right"]},{"label":["cv1"],"name":[11],"type":["dbl"],"align":["right"]},{"label":["cv2"],"name":[12],"type":["lgl"],"align":["right"]},{"label":["cv3"],"name":[13],"type":["lgl"],"align":["right"]}],"data":[{"1":"2013","2":"1.179177","3":"0.905339","4":"2.126953","5":"NA","6":"NA","7":"NA","8":"NA","9":"NA","10":"NA","11":"0.7016667","12":"NA","13":"NA","_rn_":"1"},{"1":"2014","2":"1.390357","3":"1.075836","4":"2.321549","5":"NA","6":"NA","7":"NA","8":"NA","9":"NA","10":"NA","11":"0.6931111","12":"NA","13":"NA","_rn_":"2"},{"1":"2015","2":"1.395881","3":"1.099546","4":"2.454081","5":"NA","6":"NA","7":"NA","8":"NA","9":"NA","10":"NA","11":"0.6920000","12":"NA","13":"NA","_rn_":"3"},{"1":"2016","2":"1.545665","3":"1.243462","4":"2.610043","5":"NA","6":"NA","7":"NA","8":"NA","9":"NA","10":"NA","11":"0.6973333","12":"NA","13":"NA","_rn_":"4"},{"1":"2017","2":"1.528219","3":"1.215654","4":"2.487700","5":"NA","6":"NA","7":"NA","8":"NA","9":"NA","10":"NA","11":"0.6815294","12":"NA","13":"NA","_rn_":"5"},{"1":"2018","2":"1.715294","3":"1.386802","4":"2.835950","5":"NA","6":"NA","7":"NA","8":"NA","9":"NA","10":"NA","11":"0.6893258","12":"NA","13":"NA","_rn_":"6"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section>
<section id="timeseries-plot" class="level2">
<h2 class="anchored" data-anchor-id="timeseries-plot">Timeseries plot</h2>
<p>The code constructs a time-series figure that displays the model’s annual abundance index together with its uncertainty. it takes the bootstrap table ts, plots each yearly mean as a blue point joined by a blue line, and draws a semi-transparent ribbon spanning the 95 % confidence limits. All survey years are shown on the x-axis. After printing the plot to the screen, the script saves it twice: a high-resolution JPEG for reports and an .rds file that preserves the ggplot object for later editing without having to rerun the analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>    <span class="do">## plot of time series</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (fm[m, <span class="st">"dev.expl"</span>] <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  max_val <span class="ot">&lt;-</span> <span class="fu">max</span>(ts<span class="sc">$</span>higher,<span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(ts,<span class="at">mapping=</span><span class="fu">aes</span>(year,mean),<span class="at">color=</span><span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(ts,<span class="at">mapping=</span><span class="fu">aes</span>(year,mean),<span class="at">color=</span><span class="st">"blue"</span>)<span class="sc">+</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(ts,<span class="at">mapping=</span><span class="fu">aes</span>(<span class="at">ymin=</span>lower,<span class="at">ymax=</span>higher,<span class="at">x=</span>year), <span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> ys)<span class="sc">+</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>          <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),     <span class="co"># titolo grafico</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>),                  <span class="co"># titoli assi</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>          <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),                   <span class="co"># etichette assi</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),                <span class="co"># titolo legenda</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>          <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>)                  <span class="co"># testo legenda</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>      )<span class="sc">+</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Year"</span>) <span class="sc">+</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(index_expr)<span class="sc">+</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(datasets_label)) <span class="sc">+</span> </span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(p2)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggsave</span>(<span class="fu">paste</span>(resdir, <span class="fu">paste0</span>(dname, <span class="st">"_"</span>, fm[m, <span class="dv">2</span>], <span class="st">"_"</span>, fm[m, <span class="dv">3</span>], <span class="st">"_TimeSeries_CI.jpg"</span>), <span class="at">sep =</span> <span class="st">"/"</span>), <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">width =</span> <span class="dv">9</span>, <span class="at">height =</span> <span class="dv">7</span>)</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">saveRDS</span>(p2,<span class="fu">paste</span>(resdir, <span class="fu">paste0</span>(dname, <span class="st">"_"</span>, fm[m, <span class="dv">2</span>], <span class="st">"_"</span>, fm[m, <span class="dv">3</span>], <span class="st">"_TimeSeries_CI.rds"</span>), <span class="at">sep =</span> <span class="st">"/"</span>))</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>  } <span class="co"># if dev.exp &gt; 0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="litter_modelling_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="analysis-on-model-2" class="level1">
<h1>Analysis on Model 2</h1>
<p>The workflow shown for Model 1 is executed again—line for line for Model 2 (spatial smooth + categorical year) and Model 3 (spatial smooth + linear trend). Each model is fitted with the correct family, its object and summary are saved, diagnostic splines are plotted, grid-level predictions and three-year maps are saved out, bootstrap time-series indices are generated, and the same JPEG/RDS files are exported. At each pass the master tables fm and ts_tab are updated so that, once all three loops finish, the user have a complete and directly comparable set of outputs for every candidate model.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
Family: Tweedie(p=1.663) 
Link function: log 

Formula:
kg_km2 ~ s(x, y, bs = "ds", m = c(1, 0.5), k = 128) + factor(year) + 
    offset(log(swept))

Parametric coefficients:
                 Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)        0.5843     0.3921   1.490 0.136504    
factor(year)2014   2.3544     0.4710   4.999 6.92e-07 ***
factor(year)2015   1.1406     0.5065   2.252 0.024558 *  
factor(year)2016   1.9597     0.4807   4.077 4.98e-05 ***
factor(year)2017   1.6854     0.4949   3.406 0.000689 ***
factor(year)2018   2.1659     0.4770   4.541 6.37e-06 ***
factor(year)2019   2.0793     0.4779   4.351 1.51e-05 ***
factor(year)2020   2.0204     0.5073   3.983 7.37e-05 ***
factor(year)2021   1.7955     0.5151   3.486 0.000515 ***
factor(year)2023   1.8752     0.4800   3.907 0.000100 ***
factor(year)2024   2.0826     0.4754   4.381 1.32e-05 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
         edf Ref.df     F p-value    
s(x,y) 43.38    127 1.933  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.0886   Deviance explained = 41.5%
-REML = 918.53  Scale est. = 6.9499    n = 953</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2513.903</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="litter_modelling_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>png 
  2 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="litter_modelling_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="litter_modelling_files/figure-html/unnamed-chunk-17-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="analysis-on-model-3" class="level1">
<h1>Analysis on Model 3</h1>
<p>The workflow shown for Model 1 and 2 is executed again—line for line for Model 3 (spatial smooth + linear trend). At each step the master tables <em>fm</em> and <em>ts_tab</em> are updated so that, once all three loops finish, the user have a complete and directly comparable set of outputs for every candidate model.</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>
Family: Tweedie(p=1.666) 
Link function: log 

Formula:
kg_km2 ~ s(x, y, bs = "ds", m = c(1, 0.5), k = 128) + ctime + 
    offset(log(swept))

Parametric coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)  
(Intercept) -104.33999   50.93025  -2.049   0.0408 *
ctime          0.05288    0.02523   2.096   0.0363 *
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Approximate significance of smooth terms:
         edf Ref.df     F p-value    
s(x,y) 44.57    127 2.095  &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

R-sq.(adj) =  0.0365   Deviance explained = 39.5%
-REML = 928.09  Scale est. = 7.0845    n = 953</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 2518.295</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="litter_modelling_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>png 
  2 </code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="litter_modelling_files/figure-html/unnamed-chunk-18-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="litter_modelling_files/figure-html/unnamed-chunk-18-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="merging-plots-and-results" class="level1">
<h1>Merging plots and results</h1>
<p>At the very end of the script everything comes together. The bootstrap table <em>ts_tab</em>, which now holds the annual indices and confidence limits for all three candidate models, is reshaped into a long format so that the three trajectories are reported on the same column. <em>ggplot</em> is then called to build a comparative time-series figure. Each model’s curve is shown as points and lines, coloured black for Model 1, green for Model 2 and blue for Model 3. If Model 1 produced confidence limits, its ribbon is added in semi-transparent grey beneath the three lines to give a visual gauge of uncertainty. After rendering to the screen the plot is exported in two forms: a high-resolution JPEG for static reporting and an RDS object that preserves the ggplot object for future editing. Finally, two comma-separated files are written to the results directory. The first (e.g.&nbsp;<em>Results_summary_n_km2_SUP.csv</em>) stores the fm table, which summarises deviance explained and AIC for each model; the second ( <em>Time_series_n_km2_SUP.csv</em>) contains the complete bootstrap table <em>ts_tab</em>. These text files give a concise record of model performance and yearly indices that can be inspected or imported into other software without opening R.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot time series of the three models together</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>ts_tab<span class="sc">$</span>year <span class="ot">&lt;-</span> ys</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>ts_long <span class="ot">&lt;-</span> reshape2<span class="sc">::</span><span class="fu">melt</span>(ts_tab[,<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">5</span>,<span class="dv">8</span>)],<span class="at">id.vars=</span><span class="st">"year"</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>ts_long<span class="sc">$</span>model <span class="ot">&lt;-</span> <span class="fu">substr</span>(<span class="fu">as.character</span>(ts_long<span class="sc">$</span>variable),<span class="fu">nchar</span>(<span class="fu">as.character</span>(ts_long<span class="sc">$</span>variable)),<span class="fu">nchar</span>(<span class="fu">as.character</span>(ts_long<span class="sc">$</span>variable)))</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>ts_long <span class="ot">&lt;-</span> ts_long[<span class="sc">!</span><span class="fu">is.na</span>(ts_long<span class="sc">$</span>value),]</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (fm[<span class="dv">1</span>, <span class="st">"dev.expl"</span>] <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>  p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(ts_long,<span class="at">mapping=</span><span class="fu">aes</span>(year,value,<span class="at">color=</span>model))<span class="sc">+</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(ts_long,<span class="at">mapping=</span><span class="fu">aes</span>(year,value,<span class="at">color=</span>model))<span class="sc">+</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"1"</span> <span class="ot">=</span> <span class="st">"black"</span>, <span class="st">"2"</span> <span class="ot">=</span> <span class="st">"green"</span>,<span class="st">"3"</span><span class="ot">=</span><span class="st">"blue"</span>))<span class="sc">+</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_ribbon</span>(ts_tab,<span class="at">mapping=</span><span class="fu">aes</span>(<span class="at">ymin=</span>lower_1,<span class="at">ymax=</span>higher_1,<span class="at">x=</span>year), <span class="at">alpha =</span> <span class="fl">0.1</span>)<span class="sc">+</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> ys)<span class="sc">+</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>),</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>) </span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Year"</span>) <span class="sc">+</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(index_expr)<span class="sc">+</span></span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(datasets_label))<span class="sc">+</span> </span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>  p3 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>()<span class="sc">+</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(ts_long,<span class="at">mapping=</span><span class="fu">aes</span>(year,value,<span class="at">color=</span>model))<span class="sc">+</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(ts_long,<span class="at">mapping=</span><span class="fu">aes</span>(year,value,<span class="at">color=</span>model))<span class="sc">+</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"1"</span> <span class="ot">=</span> <span class="st">"black"</span>, <span class="st">"2"</span> <span class="ot">=</span> <span class="st">"green"</span>,<span class="st">"3"</span><span class="ot">=</span><span class="st">"blue"</span>))<span class="sc">+</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> ys)<span class="sc">+</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>, <span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">16</span>),</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">axis.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>),</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.title =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">14</span>),</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">legend.text =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">13</span>) </span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">"Year"</span>) <span class="sc">+</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ylab</span>(index_expr)<span class="sc">+</span></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggtitle</span>(<span class="fu">paste</span>(datasets_label))<span class="sc">+</span> </span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>))</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(p3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="litter_modelling_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="fu">paste</span>(resdir, <span class="fu">paste0</span>(dname, <span class="st">"_"</span>, response, <span class="st">"_TimeSeries_CI_models.jpg"</span>), <span class="at">sep =</span> <span class="st">"/"</span>), <span class="at">dpi =</span> <span class="dv">300</span>, <span class="at">width =</span> <span class="dv">9</span>, <span class="at">height =</span> <span class="dv">7</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(p3,<span class="fu">paste</span>(resdir, <span class="fu">paste0</span>(dname, <span class="st">"_"</span>, response, <span class="st">"_TimeSeries_CI_models.rds"</span>), <span class="at">sep =</span> <span class="st">"/"</span>))</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(fm, <span class="fu">file.path</span>(resdir, <span class="fu">paste0</span>(<span class="st">"Results_summary_"</span>,response,<span class="st">"_"</span>,datasets,<span class="st">".csv"</span>)), <span class="at">sep =</span> <span class="st">";"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>ts_tab<span class="sc">$</span>area <span class="ot">=</span> AREA</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="fu">write.table</span>(ts_tab, <span class="fu">file.path</span>(resdir, <span class="fu">paste0</span>(<span class="st">"_Time_series_"</span>,response,<span class="st">"_"</span>,datasets,<span class="st">".csv"</span>)), <span class="at">sep =</span> <span class="st">";"</span>, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>